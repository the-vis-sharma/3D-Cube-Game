(function(){'use strict';function e(e,t,o){function a(){for(var e=Math.cos,a=[new THREE.Vector3(1,1,1),new THREE.Vector3(1,1,-1),new THREE.Vector3(-1,1,-1),new THREE.Vector3(-1,1,1),new THREE.Vector3(1,-1,1),new THREE.Vector3(1,-1,-1),new THREE.Vector3(-1,-1,-1),new THREE.Vector3(-1,-1,1)],s=0;8>s;s++)S.push([]),T.push([]);for(var r=n/2,l=new THREE.Vector3(f,w,z),c=0;c<=o;c++){var d=c/o,m=d*r,p=e(m),g=i(m);if(c==o){L.set(0,1,0);var h=L.clone().multiplyScalar(t).add(l);S[0].push(h),E.push(h);var b=L.clone();T[0].push(b),D.push(b);continue}for(var v=0;v<=o;v++){var C=v/o,u=C*r;L.x=p*e(u),L.y=g,L.z=p*i(u);var h=L.clone().multiplyScalar(t).add(l);S[0].push(h),E.push(h);var b=L.clone().normalize();T[0].push(b),D.push(b)}}for(var A=1;8>A;A++)for(var h,s=0;s<S[0].length;s++){h=S[0][s].clone().multiply(a[A]),S[A].push(h),E.push(h);var b=T[0][s].clone().multiply(a[A]);T[A].push(b),D.push(b)}}function s(){for(var e,t=[!0,!1,!0,!1,!1,!0,!1,!0],s=y*(o-1),r=0;8>r;r++){e=I*r;for(var n=0;n<o-1;n++)for(var l=n*y,m=(n+1)*y,p=0;p<o;p++){var g=p+1,h=e+l+p,f=e+l+g,x=e+m+p,w=e+m+g;t[r]?(M.push(h),M.push(x),M.push(f),M.push(f),M.push(x),M.push(w)):(M.push(h),M.push(f),M.push(x),M.push(f),M.push(w),M.push(x))}for(var p=0;p<o;p++){var h=e+s+p,f=e+s+p+1,x=e+_;t[r]?(M.push(h),M.push(x),M.push(f)):(M.push(h),M.push(f),M.push(x))}}}function r(){var e=_,t=_+I,s=_+2*I,r=_+3*I;M.push(e),M.push(t),M.push(s),M.push(e),M.push(s),M.push(r),e=_+4*I,t=_+5*I,s=_+6*I,r=_+7*I,M.push(e),M.push(s),M.push(t),M.push(e),M.push(r),M.push(s),e=0,t=I,s=4*I,r=5*I,M.push(e),M.push(s),M.push(t),M.push(t),M.push(s),M.push(r),e=2*I,t=3*I,s=6*I,r=7*I,M.push(e),M.push(s),M.push(t),M.push(t),M.push(s),M.push(r),e=o,t=o+3*I,s=o+4*I,r=o+7*I,M.push(e),M.push(t),M.push(s),M.push(t),M.push(r),M.push(s),e=o+I,t=o+2*I,s=o+5*I,r=o+6*I,M.push(e),M.push(s),M.push(t),M.push(t),M.push(s),M.push(r)}function m(){for(var e=0;4>e;e++)for(var t=e*I,s=4*I+t,r=!0&e,n=0;n<o;n++){var l=n+1,m=t+n,a=t+l,p=s+n,c=s+l;r?(M.push(m),M.push(p),M.push(a),M.push(a),M.push(p),M.push(c)):(M.push(m),M.push(a),M.push(p),M.push(a),M.push(c),M.push(p))}}function u(){for(var e=[0,2,4,6],t=[1,3,5,7],s=0;4>s;s++)for(var r=I*e[s],n=I*t[s],l=1>=s,m=0;m<o;m++){var p=m*y,g=(m+1)*y,h=r+p,a=r+g,b=n+p,c=n+g;l?(M.push(h),M.push(b),M.push(a),M.push(a),M.push(b),M.push(c)):(M.push(h),M.push(a),M.push(b),M.push(a),M.push(c),M.push(b))}}function p(){for(var e=o-1,t=[0,1,4,5],s=[3,2,7,6],r=[0,1,1,0],n=0;4>n;n++)for(var l=t[n]*I,m=s[n]*I,p=0;p<=e;p++){var g=l+o+p*y,a=l+(p==e?I-1:o+(p+1)*y),h=m+o+p*y,c=m+(p==e?I-1:o+(p+1)*y);r[n]?(M.push(g),M.push(h),M.push(a),M.push(a),M.push(h),M.push(c)):(M.push(g),M.push(a),M.push(h),M.push(a),M.push(c),M.push(h))}}THREE.BufferGeometry.call(this),this.type='RoundedBoxGeometry',o=isNaN(o)?1:c(1,d(o));var g,h,b;g=h=b=e,t=e*t,t=l(t,l(g,l(h,l(b)))/2);var f=g/2-t,w=h/2-t,z=b/2-t;this.parameters={width:g,height:h,depth:b,radius:t,radiusSegments:o};var y=o+1,v=y*o+1<<3,x=new THREE.BufferAttribute(new Float32Array(3*v),3),C=new THREE.BufferAttribute(new Float32Array(3*v),3),S=[],T=[],A=new THREE.Vector3,L=new THREE.Vector3,E=[],D=[],M=[],_=y*o,I=y*o+1;a(),r(),s(),m(),p(),u();for(var k=0,V=0;V<E.length;V++)x.setXYZ(k,E[V].x,E[V].y,E[V].z),C.setXYZ(k,D[V].x,D[V].y,D[V].z),k++;this.setIndex(new THREE.BufferAttribute(new Uint16Array(M),1)),this.addAttribute('position',x),this.addAttribute('normal',C)}function t(e,t,a){var o,s,r,i;o=s=-e/2,r=i=e,t=e*t;const n=new THREE.Shape;n.moveTo(o,s+t),n.lineTo(o,s+i-t),n.quadraticCurveTo(o,s+i,o+t,s+i),n.lineTo(o+r-t,s+i),n.quadraticCurveTo(o+r,s+i,o+r,s+i-t),n.lineTo(o+r,s+t),n.quadraticCurveTo(o+r,s,o+r-t,s),n.lineTo(o+t,s),n.quadraticCurveTo(o,s,o,s+t);const l=new THREE.ExtrudeBufferGeometry(n,{depth:a,bevelEnabled:!1,curveSegments:3});return l}var a=Math.sign,o=Math.abs,s=Math.pow,r=Math.round,i=Math.sin,n=Math.PI,l=Math.min,c=Math.max,d=Math.floor,m=Math.tan;const u=(()=>{let e=0;return new class{constructor(){this.ids=[],this.animations={},this.update=this.update.bind(this),this.raf=0,this.time=0}update(){const e=performance.now(),t=e-this.time;this.time=e;let a=this.ids.length;for(this.raf=a?requestAnimationFrame(this.update):0;a--;)this.animations[this.ids[a]]&&this.animations[this.ids[a]].update(t)}add(t){t.id=e++,this.ids.push(t.id),this.animations[t.id]=t;0!==this.raf||(this.time=performance.now(),this.raf=requestAnimationFrame(this.update))}remove(e){const t=this.ids.indexOf(e.id);0>t||(this.ids.splice(t,1),delete this.animations[e.id],e=null)}}})();class p{constructor(e){!0===e&&this.start()}start(){u.add(this)}stop(){u.remove(this)}update(){}}class g extends p{constructor(e){super(!0),this.game=e,this.container=this.game.dom.game,this.scene=new THREE.Scene,this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.container.appendChild(this.renderer.domElement),this.camera=new THREE.PerspectiveCamera(2,1,.1,1e4),this.stage={width:2,height:3},this.fov=10,this.createLights(),this.onResize=[],this.resize(),window.addEventListener('resize',()=>this.resize(),!1)}update(){this.renderer.render(this.scene,this.camera)}resize(){this.width=this.container.offsetWidth,this.height=this.container.offsetHeight,this.renderer.setSize(this.width,this.height),this.camera.fov=this.fov,this.camera.aspect=this.width/this.height;const e=this.stage.width/this.stage.height,t=this.fov*THREE.Math.DEG2RAD;let a=e<this.camera.aspect?this.stage.height/2/m(t/2):this.stage.width/this.camera.aspect/(2*m(t/2));a*=.5,this.camera.position.set(a,a,a),this.camera.lookAt(this.scene.position),this.camera.updateProjectionMatrix();const o=e<this.camera.aspect?this.height/100*e:this.width/100;document.documentElement.style.fontSize=o+'px',this.onResize&&this.onResize.forEach(e=>e())}createLights(){this.lights={holder:new THREE.Object3D,ambient:new THREE.AmbientLight(16777215,.69),front:new THREE.DirectionalLight(16777215,.36),back:new THREE.DirectionalLight(16777215,.19)},this.lights.front.position.set(1.5,5,3),this.lights.back.position.set(-1.5,-5,-3),this.lights.holder.add(this.lights.ambient),this.lights.holder.add(this.lights.front),this.lights.holder.add(this.lights.back),this.scene.add(this.lights.holder)}}e.prototype=Object.create(THREE.BufferGeometry.prototype),e.constructor=e;class h{constructor(e){this.game=e,this.size=3,this.geometry={pieceCornerRadius:.12,edgeCornerRoundness:.15,edgeScale:.82,edgeDepth:.01},this.holder=new THREE.Object3D,this.object=new THREE.Object3D,this.animator=new THREE.Object3D,this.holder.add(this.animator),this.animator.add(this.object),this.game.world.scene.add(this.holder)}init(){this.cubes=[],this.object.children=[],this.object.add(this.game.controls.group),2===this.size?this.scale=1.25:3===this.size?this.scale=1:3<this.size&&(this.scale=3/this.size),this.object.scale.set(this.scale,this.scale,this.scale);const e=2===this.size?.825:1;this.game.controls.edges.scale.set(e,e,e),this.generatePositions(),this.generateModel(),this.pieces.forEach(e=>{this.cubes.push(e.userData.cube),this.object.add(e)}),this.holder.traverse(e=>{e.frustumCulled&&(e.frustumCulled=!1)}),this.updateColors(this.game.themes.getColors()),this.sizeGenerated=this.size}resize(){this.size!==this.sizeGenerated&&(this.reset(),this.init(),this.game.saved=!1,this.game.timer.reset(),this.game.storage.clearGame())}reset(){this.game.controls.edges.rotation.set(0,0,0),this.holder.rotation.set(0,0,0),this.object.rotation.set(0,0,0),this.animator.rotation.set(0,0,0)}generatePositions(){const e=this.size-1,t=0==this.size%2?.5-this.size/2:0-d(this.size/2);let a,o,s;for(this.positions=[],a=0;a<this.size;a++)for(o=0;o<this.size;o++)for(s=0;s<this.size;s++){let r=new THREE.Vector3(t+a,t+o,t+s),i=[];0==a&&i.push(0),a==e&&i.push(1),0==o&&i.push(2),o==e&&i.push(3),0==s&&i.push(4),s==e&&i.push(5),r.edges=i,this.positions.push(r)}}generateModel(){this.pieces=[],this.edges=[];const a=1/3,o=new THREE.MeshLambertMaterial,s=new THREE.Mesh(new e(a,this.geometry.pieceCornerRadius,3),o.clone()),r=t(a,this.geometry.edgeCornerRoundness,this.geometry.edgeDepth);this.positions.forEach((e,t)=>{const i=new THREE.Object3D,l=s.clone(),c=[];i.position.copy(e.clone().divideScalar(3)),i.add(l),i.name=t,i.edgesName='',e.edges.forEach(e=>{const t=new THREE.Mesh(r,o.clone()),s=['L','R','D','U','B','F'][e],l=a/2;t.position.set(l*[-1,1,0,0,0,0][e],l*[0,0,-1,1,0,0][e],l*[0,0,0,0,-1,1][e]),t.rotation.set(n/2*[0,0,1,-1,0,0][e],n/2*[-1,1,0,0,2,0][e],0),t.scale.set(this.geometry.edgeScale,this.geometry.edgeScale,this.geometry.edgeScale),t.name=s,i.add(t),c.push(s),this.edges.push(t)}),i.userData.edges=c,i.userData.cube=l,i.userData.start={position:i.position.clone(),rotation:i.rotation.clone()},this.pieces.push(i)})}updateColors(e){'object'!=typeof this.pieces&&'object'!=typeof this.edges||(this.pieces.forEach(t=>t.userData.cube.material.color.setHex(e.P)),this.edges.forEach(t=>t.material.color.setHex(e[t.name])))}}const b={Power:{In:e=>(e=r(e||1),a=>s(a,e)),Out:e=>(e=r(e||1),a=>1-o(s(a-1,e))),InOut:e=>(e=r(e||1),a=>.5>a?s(2*a,e)/2:(1-o(s(2*a-1-1,e)))/2+.5)},Sine:{In:()=>e=>1+i(n/2*e-n/2),Out:()=>e=>i(n/2*e),InOut:()=>e=>(1+i(n*e-n/2))/2},Back:{Out:e=>(e=e||1.70158,a=>(a-=1)*a*((e+1)*a+e)+1),In:e=>(e=e||1.70158,a=>a*a*((e+1)*a-e))},Elastic:{Out:(e,t)=>{let a=2*n,o=1<=e?e:1,r=(t||.3)/(1>e?e:1),l=r/a*(Math.asin(1/o)||0);return r=a/r,e=>o*s(2,-10*e)*i((e-l)*r)+1}}};class v extends p{constructor(e){super(!1),this.duration=e.duration||500,this.easing=e.easing||(e=>e),this.onUpdate=e.onUpdate||(()=>{}),this.onComplete=e.onComplete||(()=>{}),this.delay=e.delay||!1,this.yoyo=!e.yoyo&&null,this.progress=0,this.value=0,this.delta=0,this.getFromTo(e),this.delay?setTimeout(()=>super.start(),this.delay):super.start(),this.onUpdate(this)}update(e){const t=1*this.value,a=!0===this.yoyo?-1:1;this.progress+=e/this.duration*a,this.value=this.easing(this.progress),this.delta=this.value-t,null!==this.values&&this.updateFromTo(),null===this.yoyo?1>=this.progress?this.onUpdate(this):(this.progress=1,this.value=1,this.onUpdate(this),this.onComplete(this),super.stop()):this.updateYoyo()}updateYoyo(){(1<this.progress||0>this.progress)&&(this.value=this.progress=1<this.progress?1:0,this.yoyo=!this.yoyo),this.onUpdate(this)}updateFromTo(){this.values.forEach(e=>{this.target[e]=this.from[e]+(this.to[e]-this.from[e])*this.value})}getFromTo(e){return e.target&&e.to?void(this.target=e.target||null,this.from=e.from||{},this.to=e.to||null,this.values=[],1>Object.keys(this.from).length&&Object.keys(this.to).forEach(e=>{this.from[e]=this.target[e]}),Object.keys(this.to).forEach(e=>{this.values.push(e)})):void(this.values=null)}}window.addEventListener('touchmove',()=>{}),document.addEventListener('touchmove',e=>{e.preventDefault()},{passive:!1});class f{constructor(e,t){return this.position={current:new THREE.Vector2,start:new THREE.Vector2,delta:new THREE.Vector2,old:new THREE.Vector2,drag:new THREE.Vector2},this.options=Object.assign({calcDelta:!1},t||{}),this.element=e,this.touch=null,this.drag={start:e=>{'mousedown'==e.type&&1!=e.which||'touchstart'==e.type&&1<e.touches.length||(this.getPositionCurrent(e),this.options.calcDelta&&(this.position.start=this.position.current.clone(),this.position.delta.set(0,0),this.position.drag.set(0,0)),this.touch='touchstart'==e.type,this.onDragStart(this.position),window.addEventListener(this.touch?'touchmove':'mousemove',this.drag.move,!1),window.addEventListener(this.touch?'touchend':'mouseup',this.drag.end,!1))},move:e=>{this.options.calcDelta&&(this.position.old=this.position.current.clone()),this.getPositionCurrent(e),this.options.calcDelta&&(this.position.delta=this.position.current.clone().sub(this.position.old),this.position.drag=this.position.current.clone().sub(this.position.start)),this.onDragMove(this.position)},end:e=>{this.getPositionCurrent(e),this.onDragEnd(this.position),window.removeEventListener(this.touch?'touchmove':'mousemove',this.drag.move,!1),window.removeEventListener(this.touch?'touchend':'mouseup',this.drag.end,!1)}},this.onDragStart=()=>{},this.onDragMove=()=>{},this.onDragEnd=()=>{},this.enable(),this}enable(){return this.element.addEventListener('touchstart',this.drag.start,!1),this.element.addEventListener('mousedown',this.drag.start,!1),this}disable(){return this.element.removeEventListener('touchstart',this.drag.start,!1),this.element.removeEventListener('mousedown',this.drag.start,!1),this}getPositionCurrent(e){const t=e.touches?e.touches[0]||e.changedTouches[0]:e;this.position.current.set(t.pageX,t.pageY)}convertPosition(e){return e.x=2*(e.x/this.element.offsetWidth)-1,e.y=-(2*(e.y/this.element.offsetHeight)-1),e}}const y=0;class x{constructor(e){this.game=e,this.flipConfig=0,this.flipEasings=[b.Power.Out(3),b.Sine.Out(),b.Back.Out(1.5)],this.flipSpeeds=[125,200,300],this.raycaster=new THREE.Raycaster;const t=new THREE.MeshBasicMaterial({depthWrite:!1,transparent:!0,opacity:0,color:13311});this.group=new THREE.Object3D,this.group.name='controls',this.game.cube.object.add(this.group),this.helper=new THREE.Mesh(new THREE.PlaneBufferGeometry(200,200),t.clone()),this.helper.rotation.set(0,n/4,0),this.game.world.scene.add(this.helper),this.edges=new THREE.Mesh(new THREE.BoxBufferGeometry(1,1,1),t.clone()),this.game.world.scene.add(this.edges),this.onSolved=()=>{},this.onMove=()=>{},this.momentum=[],this.scramble=null,this.state=y,this.enabled=!1,this.initDraggable()}enable(){this.draggable.enable(),this.enabled=!0}disable(){this.draggable.disable(),this.enabled=!1}initDraggable(){this.draggable=new f(this.game.dom.game),this.draggable.onDragStart=e=>{if(null===this.scramble&&1!==this.state&&2!==this.state){this.gettingDrag=3===this.state;const t=this.getIntersect(e.current,this.edges,!1);!1!==t&&(this.dragIntersect=this.getIntersect(e.current,this.game.cube.cubes,!0)),!1!==t&&!1!==this.dragIntersect?(this.dragNormal=t.face.normal.round(),this.flipType='layer',this.attach(this.helper,this.edges),this.helper.rotation.set(0,0,0),this.helper.position.set(0,0,0),this.helper.lookAt(this.dragNormal),this.helper.translateZ(.5),this.helper.updateMatrixWorld(),this.detach(this.helper,this.edges)):(this.dragNormal=new THREE.Vector3(0,0,1),this.flipType='cube',this.helper.position.set(0,0,0),this.helper.rotation.set(0,n/4,0),this.helper.updateMatrixWorld());let a=this.getIntersect(e.current,this.helper,!1);!1===a||(this.dragCurrent=this.helper.worldToLocal(a.point),this.dragTotal=new THREE.Vector3,this.state=this.state===y?1:this.state)}},this.draggable.onDragMove=e=>{if(null===this.scramble&&this.state!==y&&(3!==this.state||!1!==this.gettingDrag)){const t=this.getIntersect(e.current,this.helper,!1);if(!1!==t){const a=this.helper.worldToLocal(t.point.clone());if(this.dragDelta=a.clone().sub(this.dragCurrent).setZ(0),this.dragTotal.add(this.dragDelta),this.dragCurrent=a,this.addMomentumPoint(this.dragDelta),1===this.state&&.05<this.dragTotal.length()){if(this.dragDirection=this.getMainAxis(this.dragTotal),'layer'===this.flipType){const e=new THREE.Vector3;e[this.dragDirection]=1;const t=this.helper.localToWorld(e).sub(this.helper.position),a=this.edges.worldToLocal(t).round();this.flipAxis=a.cross(this.dragNormal).negate(),this.selectLayer(this.getLayer(!1))}else{const t='x'==this.dragDirection?'y':'y'==this.dragDirection&&e.current.x>this.game.world.width/2?'z':'x';this.flipAxis=new THREE.Vector3,this.flipAxis[t]=1*('x'==t?-1:1)}this.flipAngle=0,this.state=2}else if(2===this.state){const e=this.dragDelta[this.dragDirection];'layer'===this.flipType?(this.group.rotateOnAxis(this.flipAxis,e),this.flipAngle+=e):(this.edges.rotateOnWorldAxis(this.flipAxis,e),this.game.cube.object.rotation.copy(this.edges.rotation),this.flipAngle+=e)}}}},this.draggable.onDragEnd=()=>{if(null===this.scramble){if(2!==this.state)return this.gettingDrag=!1,void(this.state=y);this.state=3;const e=this.getMomentum()[this.dragDirection],t=.05<o(e)&&o(this.flipAngle)<n/2,s=t?this.roundAngle(this.flipAngle+a(this.flipAngle)*(n/4)):this.roundAngle(this.flipAngle),r=s-this.flipAngle;'layer'===this.flipType?this.rotateLayer(r,!1,()=>{this.game.storage.saveGame(),this.state=this.gettingDrag?1:y,this.gettingDrag=!1,this.checkIsSolved()}):this.rotateCube(r,()=>{this.state=this.gettingDrag?1:y,this.gettingDrag=!1})}}}rotateLayer(e,t,a){const o=t?0:this.flipConfig,s=this.flipEasings[o],r=this.flipSpeeds[o],i=2==o?this.bounceCube():()=>{};this.rotationTween=new v({easing:s,duration:r,onUpdate:t=>{let a=t.delta*e;this.group.rotateOnAxis(this.flipAxis,a),i(t.value,a,e)},onComplete:()=>{t||this.onMove();const e=this.flipLayer.slice(0);this.game.cube.object.rotation.setFromVector3(this.snapRotation(this.game.cube.object.rotation.toVector3())),this.group.rotation.setFromVector3(this.snapRotation(this.group.rotation.toVector3())),this.deselectLayer(this.flipLayer),a(e)}})}bounceCube(){let e=!0;return(t,a,o)=>{1<=t&&(e&&(a=(t-1)*o,e=!1),this.game.cube.object.rotateOnAxis(this.flipAxis,a))}}rotateCube(e,t){const a=this.flipConfig,o=[b.Power.Out(4),b.Sine.Out(),b.Back.Out(2)][a],s=[100,150,350][a];this.rotationTween=new v({easing:o,duration:s,onUpdate:t=>{this.edges.rotateOnWorldAxis(this.flipAxis,t.delta*e),this.game.cube.object.rotation.copy(this.edges.rotation)},onComplete:()=>{this.edges.rotation.setFromVector3(this.snapRotation(this.edges.rotation.toVector3())),this.game.cube.object.rotation.copy(this.edges.rotation),t()}})}selectLayer(e){this.group.rotation.set(0,0,0),this.movePieces(e,this.game.cube.object,this.group),this.flipLayer=e}deselectLayer(e){this.movePieces(e,this.group,this.game.cube.object),this.flipLayer=null}movePieces(e,t,a){t.updateMatrixWorld(),a.updateMatrixWorld(),e.forEach(e=>{const o=this.game.cube.pieces[e];o.applyMatrix(t.matrixWorld),t.remove(o),o.applyMatrix(new THREE.Matrix4().getInverse(a.matrixWorld)),a.add(o)})}getLayer(e){const t={2:6,3:3,4:4,5:3}[this.game.cube.size],a=[];let o;if(!1===e){const a=this.dragIntersect.object.parent;o=this.getMainAxis(this.flipAxis),e=a.position.clone().multiplyScalar(t).round()}else o=this.getMainAxis(e);return this.game.cube.pieces.forEach(s=>{const r=s.position.clone().multiplyScalar(t).round();r[o]==e[o]&&a.push(s.name)}),a}keyboardMove(e,t){if(this.state===y&&!0===this.enabled)if('LAYER'===e){const e=this.getLayer(t.position);this.flipAxis=new THREE.Vector3,this.flipAxis[t.axis]=1,this.state=2,this.selectLayer(e),this.rotateLayer(t.angle,!1,()=>{this.game.storage.saveGame(),this.state=y,this.checkIsSolved()})}else'CUBE'===e&&(this.flipAxis=new THREE.Vector3,this.flipAxis[t.axis]=1,this.state=2,this.rotateCube(t.angle,()=>{this.state=y}))}scrambleCube(){null==this.scramble&&(this.scramble=this.game.scrambler,this.scramble.callback='function'==typeof callback?callback:()=>{});const e=this.scramble.converted,t=e[0],a=this.getLayer(t.position);this.flipAxis=new THREE.Vector3,this.flipAxis[t.axis]=1,this.selectLayer(a),this.rotateLayer(t.angle,!0,()=>{e.shift(),0<e.length?this.scrambleCube():(this.scramble=null,this.game.storage.saveGame())})}getIntersect(e,t,a){this.raycaster.setFromCamera(this.draggable.convertPosition(e.clone()),this.game.world.camera);const o=a?this.raycaster.intersectObjects(t):this.raycaster.intersectObject(t);return!!(0<o.length)&&o[0]}getMainAxis(e){return Object.keys(e).reduce((t,a)=>o(e[t])>o(e[a])?t:a)}detach(e,t){e.applyMatrix(t.matrixWorld),t.remove(e),this.game.world.scene.add(e)}attach(e,t){e.applyMatrix(new THREE.Matrix4().getInverse(t.matrixWorld)),this.game.world.scene.remove(e),t.add(e)}addMomentumPoint(e){const t=Date.now();this.momentum=this.momentum.filter(e=>500>t-e.time),!1!==e&&this.momentum.push({delta:e,time:t})}getMomentum(){const e=this.momentum.length,t=new THREE.Vector2;return this.addMomentumPoint(!1),this.momentum.forEach((a,o)=>{t.add(a.delta.multiplyScalar(o/e))}),t}roundAngle(e){const t=n/2;return a(e)*r(o(e)/t)*t}snapRotation(e){return e.set(this.roundAngle(e.x),this.roundAngle(e.y),this.roundAngle(e.z))}checkIsSolved(){performance.now();let e=!0;const t={"x-":[],"x+":[],"y-":[],"y+":[],"z-":[],"z+":[]};this.game.cube.edges.forEach(e=>{const a=e.parent.localToWorld(e.position.clone()).sub(this.game.cube.object.position),o=this.getMainAxis(a),s=1>a.multiplyScalar(2).round()[o]?'-':'+';t[o+s].push(e.name)}),Object.keys(t).forEach(a=>{t[a].every(e=>e===t[a][0])||(e=!1)}),e&&this.onSolved()}}class w{constructor(e){this.game=e,this.dificulty=0,this.scrambleLength={2:[7,9,11],3:[20,25,30],4:[30,40,50],5:[40,60,80]},this.moves=[],this.conveted=[],this.pring=''}scramble(e){let t=0;if(this.moves='undefined'==typeof e?[]:e.split(' '),1>this.moves.length){const a=this.scrambleLength[this.game.cube.size][this.dificulty],o=4>this.game.cube.size?'UDLRFB':'UuDdLlRrFfBb',s=['','\'','2'],r='undefined'==typeof e?a:e;for(;t<r;){const e=o[d(Math.random()*o.length)]+s[d(3*Math.random())];0<t&&e.charAt(0)==this.moves[t-1].charAt(0)||1<t&&e.charAt(0)==this.moves[t-2].charAt(0)||(this.moves.push(e),t++)}}return this.callback=()=>{},this.convert(),this.print=this.moves.join(' '),this}convert(){this.converted=[],this.moves.forEach(e=>{const t=this.convertMove(e),a=e.charAt(1);this.converted.push(t),'2'==a&&this.converted.push(t)})}convertMove(e){const t=e.charAt(0),a=e.charAt(1),o={D:'y',U:'y',L:'x',R:'x',F:'z',B:'z'}[t.toUpperCase()];let s={D:-1,U:1,L:-1,R:1,F:1,B:-1}[t.toUpperCase()];3<this.game.cube.size&&t!==t.toLowerCase()&&(s*=2);const r=new THREE.Vector3;r[{D:'y',U:'y',L:'x',R:'x',F:'z',B:'z'}[t.toUpperCase()]]=s;const i=n/2*-s*('\''==a?-1:1);return{position:r,axis:o,angle:i,name:e}}}class z{constructor(e){this.game=e,this.tweens={},this.durations={},this.data={cubeY:-.2,cameraZoom:.85},this.activeTransitions=0}init(){this.game.controls.disable(),this.game.cube.object.position.y=this.data.cubeY,this.game.cube.animator.position.y=4,this.game.cube.animator.rotation.x=-n/3,this.game.world.camera.zoom=this.data.cameraZoom,this.game.world.camera.updateProjectionMatrix(),this.tweens.buttons={},this.tweens.timer=[],this.tweens.title=[],this.tweens.best=[],this.tweens.complete=[],this.tweens.range=[],this.tweens.stats=[]}buttons(e,t){const a=(e,t)=>new v({target:e.style,duration:300,easing:t?b.Power.Out(2):b.Power.In(3),from:{opacity:t?0:1},to:{opacity:t?1:0},onUpdate:a=>{const o=t?1-a.value:a.value;e.style.transform=`translate3d(0, ${1.5*o}em, 0)`},onComplete:()=>e.style.pointerEvents=t?'all':'none'});t.forEach(e=>this.tweens.buttons[e]=a(this.game.dom.buttons[e],!1)),setTimeout(()=>e.forEach(e=>{this.tweens.buttons[e]=a(this.game.dom.buttons[e],!0)}),t?500:0)}cube(e){this.activeTransitions++;try{this.tweens.cube.stop()}catch(t){}const t=this.game.cube.animator.position.y,a=this.game.cube.animator.rotation.x;this.tweens.cube=new v({duration:e?3e3:1250,easing:e?b.Elastic.Out(.8,.6):b.Back.In(1),onUpdate:o=>{this.game.cube.animator.position.y=e?4*(1-o.value):t+4*o.value,this.game.cube.animator.rotation.x=e?(1-o.value)*n/3:a+o.value*-n/3}}),this.durations.cube=e?1500:1500,setTimeout(()=>this.activeTransitions--,this.durations.cube)}float(){try{this.tweens.float.stop()}catch(t){}this.tweens.float=new v({duration:1500,easing:b.Sine.InOut(),yoyo:!0,onUpdate:e=>{this.game.cube.holder.position.y=-.02+.04*e.value,this.game.cube.holder.rotation.x=.005-.01*e.value,this.game.cube.holder.rotation.z=-this.game.cube.holder.rotation.x,this.game.cube.holder.rotation.y=this.game.cube.holder.rotation.x,this.game.controls.edges.position.y=this.game.cube.holder.position.y+this.game.cube.object.position.y}})}zoom(e,t){this.activeTransitions++;const a=e?1:this.data.cameraZoom,o=0<t?c(t,1500):1500,s=0<t?r(o/1500):1,i=b.Power.InOut(0<t?2:3);this.tweens.zoom=new v({target:this.game.world.camera,duration:o,easing:i,to:{zoom:a},onUpdate:()=>{this.game.world.camera.updateProjectionMatrix()}}),this.tweens.rotate=new v({target:this.game.cube.animator.rotation,duration:o,easing:i,to:{y:2*-n*s},onComplete:()=>{this.game.cube.animator.rotation.y=0}}),this.durations.zoom=o,setTimeout(()=>this.activeTransitions--,this.durations.zoom)}elevate(e){this.activeTransitions++;this.tweens.elevate=new v({target:this.game.cube.object.position,duration:e?1500:0,easing:b.Power.InOut(3),to:{y:e?-.05:this.data.cubeY}});this.durations.elevate=1500,setTimeout(()=>this.activeTransitions--,this.durations.elevate)}complete(e,t){this.activeTransitions++;const a=t?this.game.dom.texts.best:this.game.dom.texts.complete;null===a.querySelector('span i')&&a.querySelectorAll('span').forEach(e=>this.splitLetters(e));const o=a.querySelectorAll('.icon, i');this.flipLetters(t?'best':'complete',o,e),a.style.opacity=1;const s=this.durations[t?'best':'complete'];e||setTimeout(()=>this.game.dom.texts.timer.style.transform='',s),setTimeout(()=>this.activeTransitions--,s)}stats(e){e&&this.game.scores.calcStats(),this.activeTransitions++,this.tweens.stats.forEach(e=>{e.stop(),e=null});let t=-1;const a=this.game.dom.stats.querySelectorAll('.stats'),o=e?b.Power.Out(2):b.Power.In(3);a.forEach((a,s)=>{const r=s*(e?80:60);this.tweens.stats[t++]=new v({delay:r,duration:400,easing:o,onUpdate:t=>{const o=e?2*(1-t.value):t.value,s=e?t.value:1-t.value;a.style.transform=`translate3d(0, ${o}em, 0)`,a.style.opacity=s}})}),this.durations.stats=0,setTimeout(()=>this.activeTransitions--,this.durations.stats)}preferences(e){this.activeTransitions++,this.tweens.range.forEach(e=>{e.stop(),e=null});let t=-1,a=0;const o=this.game.dom.prefs.querySelectorAll('.range'),s=e?b.Power.Out(2):b.Power.In(3);o.forEach((o,r)=>{const i=o.querySelector('.range__label'),n=o.querySelector('.range__track-line'),l=o.querySelector('.range__handle'),c=o.querySelectorAll('.range__list div'),d=r*(e?120:100);i.style.opacity=e?0:1,n.style.opacity=e?0:1,l.style.opacity=e?0:1,l.style.pointerEvents=e?'all':'none',this.tweens.range[t++]=new v({delay:e?d:d,duration:400,easing:s,onUpdate:t=>{const a=e?1-t.value:t.value,o=e?t.value:1-t.value;i.style.transform=`translate3d(0, ${a}em, 0)`,i.style.opacity=o}}),this.tweens.range[t++]=new v({delay:e?d+100:d,duration:400,easing:s,onUpdate:t=>{const a=e?1-t.value:t.value,o=e?t.value:1-t.value;n.style.transform=`translate3d(0, ${a}em, 0) scale3d(${o}, 1, 1)`,n.style.opacity=o}}),this.tweens.range[t++]=new v({delay:e?d+100:d,duration:400,easing:s,onUpdate:t=>{const a=e?1-t.value:t.value,o=1-a,s=.5+.5*o;l.style.transform=`translate3d(0, ${a}em, 0) scale3d(${s}, ${s}, ${s})`,l.style.opacity=o}}),c.forEach((a,o)=>{a.style.opacity=e?0:1,this.tweens.range[t++]=new v({delay:e?d+200+50*o:d,duration:400,easing:s,onUpdate:t=>{const o=e?1-t.value:t.value,s=e?t.value:1-t.value;a.style.transform=`translate3d(0, ${o}em, 0)`,a.style.opacity=s}})}),a=c.length>a?c.length-1:a,o.style.opacity=1}),this.durations.preferences=e?100*(o.length-1)+200+50*a+400:100*(o.length-1)+400,setTimeout(()=>this.activeTransitions--,this.durations.preferences)}title(e){this.activeTransitions++;const t=this.game.dom.texts.title;null===t.querySelector('span i')&&t.querySelectorAll('span').forEach(e=>this.splitLetters(e));const a=t.querySelectorAll('i');this.flipLetters('title',a,e),t.style.opacity=1;const o=this.game.dom.texts.note;this.tweens.title[a.length]=new v({target:o.style,easing:b.Sine.InOut(),duration:e?800:400,yoyo:!!e||null,from:{opacity:e?0:parseFloat(getComputedStyle(o).opacity)},to:{opacity:e?1:0}}),setTimeout(()=>this.activeTransitions--,this.durations.title)}timer(e){this.activeTransitions++;const t=this.game.dom.texts.timer;t.style.opacity=0,this.game.timer.convert(),this.game.timer.setText(),this.splitLetters(t);const a=t.querySelectorAll('i');this.flipLetters('timer',a,e),t.style.opacity=1,setTimeout(()=>this.activeTransitions--,this.durations.timer)}splitLetters(e){const t=e.innerHTML;e.innerHTML='',t.split('').forEach(t=>{const a=document.createElement('i');a.innerHTML=t,e.appendChild(a)})}flipLetters(e,t,a){try{this.tweens[e].forEach(e=>e.stop())}catch(t){}t.forEach((t,o)=>{t.style.opacity=a?0:1,this.tweens[e][o]=new v({easing:b.Sine.Out(),duration:a?800:400,delay:50*o,onUpdate:e=>{const o=a?-80*(1-e.value):80*e.value;t.style.transform=`rotate3d(0, 1, 0, ${o}deg)`,t.style.opacity=a?e.value:1-e.value}})}),this.durations[e]=50*(t.length-1)+(a?800:400)}}class C extends p{constructor(e){super(!1),this.game=e,this.reset()}start(e){this.startTime=e?Date.now()-this.deltaTime:Date.now(),this.deltaTime=0,this.converted=this.convert(),super.start()}reset(){this.startTime=0,this.currentTime=0,this.deltaTime=0,this.converted='0:00'}stop(){return this.currentTime=Date.now(),this.deltaTime=this.currentTime-this.startTime,this.convert(),super.stop(),{time:this.converted,millis:this.deltaTime}}update(){const e=this.converted;this.currentTime=Date.now(),this.deltaTime=this.currentTime-this.startTime,this.convert(),this.converted!=e&&(localStorage.setItem('theCube_time',this.deltaTime),this.setText())}convert(){const e=parseInt(this.deltaTime/1e3%60),t=parseInt(this.deltaTime/60000);this.converted=t+':'+(10>e?'0':'')+e}setText(){this.game.dom.texts.timer.innerHTML=this.converted}}document.querySelectorAll('range').forEach(e=>{const t=document.createElement('div');t.innerHTML='<div class="range">\n<div class="range__label"></div>\n<div class="range__track">\n<div class="range__track-line"></div>\n<div class="range__handle"><div></div></div>\n</div>\n<div class="range__list"></div>\n</div>';const a=t.querySelector('.range'),o=a.querySelector('.range__label'),s=a.querySelector('.range__list');a.setAttribute('name',e.getAttribute('name')),o.innerHTML=e.getAttribute('title'),e.getAttribute('list').split(',').forEach(e=>{const t=document.createElement('div');t.innerHTML=e,s.appendChild(t)}),e.parentNode.replaceChild(a,e)});class S{constructor(e,t){t=Object.assign({range:[0,1],value:0,step:0,onUpdate:()=>{},onComplete:()=>{}},t||{}),this.element=document.querySelector('.range[name="'+e+'"]'),this.track=this.element.querySelector('.range__track'),this.handle=this.element.querySelector('.range__handle'),this.list=[].slice.call(this.element.querySelectorAll('.range__list div')),this.value=t.value,this.min=t.range[0],this.max=t.range[1],this.step=t.step,this.onUpdate=t.onUpdate,this.onComplete=t.onComplete,this.value=this.round(this.limitValue(this.value)),this.setHandlePosition(),this.initDraggable()}initDraggable(){let e;this.draggable=new f(this.handle,{calcDelta:!0}),this.draggable.onDragStart=()=>{e=this.positionFromValue(this.value),this.handle.style.left=e+'px'},this.draggable.onDragMove=t=>{e=this.limitPosition(e+t.delta.x),this.value=this.round(this.valueFromPosition(e)),this.setHandlePosition(),this.onUpdate(this.value)},this.draggable.onDragEnd=()=>{this.onComplete(this.value)}}round(e){return 1>this.step?e:r((e-this.min)/this.step)*this.step+this.min}limitValue(e){const t=c(this.max,this.min),a=l(this.max,this.min);return l(c(e,a),t)}limitPosition(e){return l(c(e,0),this.track.offsetWidth)}percentsFromValue(e){return(e-this.min)/(this.max-this.min)}valueFromPosition(e){return this.min+(this.max-this.min)*(e/this.track.offsetWidth)}positionFromValue(e){return this.percentsFromValue(e)*this.track.offsetWidth}setHandlePosition(){this.handle.style.left=100*this.percentsFromValue(this.value)+'%'}}class T{constructor(e){this.game=e}init(){this.ranges={size:new S('size',{value:this.game.cube.size,range:[2,5],step:1,onUpdate:e=>{this.game.cube.size=e,this.game.preferences.ranges.scramble.list.forEach((e,t)=>{e.innerHTML=this.game.scrambler.scrambleLength[this.game.cube.size][t]})},onComplete:()=>this.game.storage.savePreferences()}),flip:new S('flip',{value:this.game.controls.flipConfig,range:[0,2],step:1,onUpdate:e=>{this.game.controls.flipConfig=e},onComplete:()=>this.game.storage.savePreferences()}),scramble:new S('scramble',{value:this.game.scrambler.dificulty,range:[0,2],step:1,onUpdate:e=>{this.game.scrambler.dificulty=e},onComplete:()=>this.game.storage.savePreferences()}),fov:new S('fov',{value:this.game.world.fov,range:[2,45],onUpdate:e=>{this.game.world.fov=e,this.game.world.resize()},onComplete:()=>this.game.storage.savePreferences()}),theme:new S('theme',{value:{cube:0,erno:1,dust:2,camo:3,rain:4}[this.game.themes.theme],range:[0,4],step:1,onUpdate:e=>{const t=['cube','erno','dust','camo','rain'][e];this.game.themes.setTheme(t)},onComplete:()=>this.game.storage.savePreferences()})},this.ranges.scramble.list.forEach((e,t)=>{e.innerHTML=this.game.scrambler.scrambleLength[this.game.cube.size][t]})}}class A{constructor(e){this.game=e,this.started=0,this.options={speed:{min:.0011,max:.0022},revolution:{min:.01,max:.05},size:{min:.1,max:.15},colors:[4303560,8571448,16772936,15677731,16747530]},this.geometry=new THREE.PlaneGeometry(1,1),this.material=new THREE.MeshLambertMaterial({side:THREE.DoubleSide}),this.holders=[new L(this.game,this,1,20),new L(this.game,this,-1,30)]}start(){0<this.started||this.holders.forEach(e=>{this.game.world.scene.add(e.holder),e.start(),this.started++})}stop(){0==this.started||this.holders.forEach(e=>{e.stop(()=>{this.game.world.scene.remove(e.holder),this.started--})})}updateColors(e){this.holders.forEach(t=>{t.options.colors.forEach((a,o)=>{t.options.colors[o]=e[['D','F','R','B','L'][o]]})})}}class L extends p{constructor(e,t,a,o){super(!1),this.game=e,this.parent=t,this.distanceFromCube=a,this.count=o,this.particles=[],this.holder=new THREE.Object3D,this.holder.rotation.copy(this.game.world.camera.rotation),this.object=new THREE.Object3D,this.holder.add(this.object),this.resizeViewport=this.resizeViewport.bind(this),this.game.world.onResize.push(this.resizeViewport),this.resizeViewport(),this.geometry=this.parent.geometry,this.material=this.parent.material,this.options=this.parent.options;for(let s=this.count;s--;)this.particles.push(new E(this))}start(){this.time=performance.now(),this.playing=!0;for(let e=this.count;e--;)this.particles[e].reset();super.start()}stop(e){this.playing=!1,this.completed=0,this.callback=e}reset(){super.stop(),this.callback()}update(){const e=performance.now(),t=e-this.time;this.time=e;for(let e=this.count;e--;)this.particles[e].completed||this.particles[e].update(t);this.playing||this.completed!=this.count||this.reset()}resizeViewport(){const e=this.game.world.camera.fov*THREE.Math.DEG2RAD;this.height=2*m(e/2)*(this.game.world.camera.position.length()-this.distanceFromCube),this.width=this.height*this.game.world.camera.aspect;const t=1/this.game.transition.data.cameraZoom;this.width*=t,this.height*=t,this.object.position.z=this.distanceFromCube,this.object.position.y=this.height/2}}class E{constructor(e){return this.confetti=e,this.options=this.confetti.options,this.velocity=new THREE.Vector3,this.force=new THREE.Vector3,this.mesh=new THREE.Mesh(this.confetti.geometry,this.confetti.material.clone()),this.confetti.object.add(this.mesh),this.size=THREE.Math.randFloat(this.options.size.min,this.options.size.max),this.mesh.scale.set(this.size,this.size,this.size),this}reset(e=!0){this.completed=!1,this.color=new THREE.Color(this.options.colors[d(Math.random()*this.options.colors.length)]),this.mesh.material.color.set(this.color),this.speed=-1*THREE.Math.randFloat(this.options.speed.min,this.options.speed.max),this.mesh.position.x=THREE.Math.randFloat(-this.confetti.width/2,this.confetti.width/2),this.mesh.position.y=e?THREE.Math.randFloat(this.size,this.confetti.height+this.size):this.size,this.revolutionSpeed=THREE.Math.randFloat(this.options.revolution.min,this.options.revolution.max),this.revolutionAxis=['x','y','z'][d(3*Math.random())],this.mesh.rotation.set(Math.random()*n/3,Math.random()*n/3,Math.random()*n/3)}stop(){this.completed=!0,this.confetti.completed++}update(e){this.mesh.position.y+=this.speed*e,this.mesh.rotation[this.revolutionAxis]+=this.revolutionSpeed,this.mesh.position.y<-this.confetti.height-this.size&&(this.confetti.playing?this.reset(!1):this.stop())}}class D{constructor(e){this.game=e,this.data={2:{scores:[],solves:0,best:0,worst:0},3:{scores:[],solves:0,best:0,worst:0},4:{scores:[],solves:0,best:0,worst:0},5:{scores:[],solves:0,best:0,worst:0}}}addScore(e){const t=this.data[this.game.cube.sizeGenerated];t.scores.push(e),t.solves++,100<t.scores.lenght&&t.scores.shift();let a=!1;return(e<t.best||0===t.best)&&(t.best=e,a=!0),e>t.worst&&(t.worst=e),this.game.storage.saveScores(),a}calcStats(){const e=this.data[this.game.cube.sizeGenerated];this.setStat('cube-size',this.game.cube.sizeGenerated),this.setStat('total-solves',e.solves),this.setStat('best-time',this.convertTime(e.best)),this.setStat('worst-time',this.convertTime(e.worst)),this.setStat('average-5',this.getAverage(5)),this.setStat('average-12',this.getAverage(12)),this.setStat('average-25',this.getAverage(25))}setStat(e,t){0===t||(this.game.dom.stats.querySelector(`.stats[name="${e}"] b`).innerHTML=t)}getAverage(e){const t=this.data[this.game.cube.sizeGenerated];return t.scores.length<e?0:this.convertTime(t.scores.slice(-e).reduce((e,t)=>e+t,0)/e)}convertTime(e){if(0>=e)return 0;const t=parseInt(e/1e3%60),a=parseInt(e/60000);return a+':'+(10>t?'0':'')+t}}class M{constructor(e){this.game=e;const t=localStorage.getItem('theCube_version');t&&t===window.gameVersion||(this.clearGame(),this.clearPreferences(),this.migrateScores(),localStorage.setItem('theCube_version',window.gameVersion))}init(){this.loadPreferences(),this.loadScores()}loadGame(){try{const e='true'===localStorage.getItem('theCube_playing');if(!e)throw new Error;const t=JSON.parse(localStorage.getItem('theCube_savedState')),a=parseInt(localStorage.getItem('theCube_time'));if(!t||null===a)throw new Error;if(t.size!==this.game.cube.sizeGenerated)throw new Error;this.game.cube.pieces.forEach(e=>{const a=t.names.indexOf(e.name),o=t.positions[a],s=t.rotations[a];e.position.set(o.x,o.y,o.z),e.rotation.set(s.x,s.y,s.z)}),this.game.timer.deltaTime=a,this.game.saved=!0}catch(t){this.game.saved=!1}}saveGame(){const e={names:[],positions:[],rotations:[]},t=this.game.timer.deltaTime;e.size=this.game.cube.sizeGenerated,this.game.cube.pieces.forEach(t=>{e.names.push(t.name),e.positions.push(t.position),e.rotations.push(t.rotation.toVector3())}),localStorage.setItem('theCube_playing',!0),localStorage.setItem('theCube_savedState',JSON.stringify(e)),localStorage.setItem('theCube_time',t)}clearGame(){localStorage.removeItem('theCube_playing'),localStorage.removeItem('theCube_savedState'),localStorage.removeItem('theCube_time')}loadScores(){try{const e=JSON.parse(localStorage.getItem('theCube_scores'));if(!e)throw new Error;this.game.scores.data=e}catch(t){}}saveScores(){const e=this.game.scores.data;localStorage.setItem('theCube_scores',JSON.stringify(e))}clearScores(){localStorage.removeItem('theCube_scores')}migrateScores(){try{const e=JSON.parse(localStorage.getItem('theCube_scoresData')),t=parseInt(localStorage.getItem('theCube_scoresBest')),a=parseInt(localStorage.getItem('theCube_scoresWorst')),o=parseInt(localStorage.getItem('theCube_scoresSolves'));if(!e||!t||!o||!a)return!1;this.game.scores.data[3].scores=e,this.game.scores.data[3].best=t,this.game.scores.data[3].solves=o,this.game.scores.data[3].worst=a,localStorage.removeItem('theCube_scoresData'),localStorage.removeItem('theCube_scoresBest'),localStorage.removeItem('theCube_scoresWorst'),localStorage.removeItem('theCube_scoresSolves')}catch(t){}}loadPreferences(){try{const e=JSON.parse(localStorage.getItem('theCube_preferences'));if(!e)throw new Error;return this.game.cube.size=parseInt(e.cubeSize),this.game.controls.flipConfig=parseInt(e.flipConfig),this.game.scrambler.dificulty=parseInt(e.dificulty),this.game.world.fov=parseFloat(e.fov),this.game.world.resize(),this.game.themes.setTheme(e.theme),!0}catch(t){return this.game.cube.size=3,this.game.controls.flipConfig=0,this.game.scrambler.dificulty=1,this.game.world.fov=10,this.game.world.resize(),this.game.themes.setTheme('cube'),this.savePreferences(),!1}}savePreferences(){const e={cubeSize:this.game.cube.size,flipConfig:this.game.controls.flipConfig,dificulty:this.game.scrambler.dificulty,fov:this.game.world.fov,theme:this.game.themes.theme};localStorage.setItem('theCube_preferences',JSON.stringify(e))}clearPreferences(){localStorage.removeItem('theCube_preferences')}}class _{constructor(e){this.game=e,this.theme=null,this.colors={cube:{U:16775167,D:16772936,F:15677731,R:4303560,B:16747530,L:8571448,P:528410,G:13751771},erno:{U:16777215,D:16766208,F:12852794,R:20922,B:16734208,L:40544,P:1118481,G:9092607},dust:{U:16774891,D:15189133,F:9381182,R:6323817,B:12480354,L:8691549,P:1118481,G:15189133},camo:{U:16774891,D:12564082,F:8411185,R:7439446,B:3613724,L:3621661,P:1118481,G:12564082},rain:{U:16448255,D:15579437,F:13508917,R:4496009,B:15489071,L:10725703,P:1118481,G:8894892}}}getColors(){return this.colors[this.theme]}setTheme(e){if(e===this.theme)return;this.theme=e;const t=this.getColors();this.game.dom.rangeHandles.forEach(e=>{e.style.background='#'+t.R.toString(16).padStart(6,'0')}),this.game.cube.updateColors(t),this.game.confetti.updateColors(t),this.game.dom.back.style.background='#'+t.G.toString(16).padStart(6,'0')}}const I=new class{constructor(e){if(e=Object.assign({tagName:'icon',className:'icon',styles:!1,icons:{},observe:!1,convert:!1},e||{}),this.tagName=e.tagName,this.className=e.className,this.icons=e.icons,this.svgTag=document.createElementNS('http://www.w3.org/2000/svg','svg'),this.svgTag.setAttribute('class',this.className),e.styles&&this.addStyles(),e.convert&&this.convertAllIcons(),e.observe){const e=window.MutationObserver||window.WebKitMutationObserver;this.observer=new e(()=>{this.convertAllIcons()}),this.observer.observe(document.documentElement,{childList:!0,subtree:!0})}return this}convertAllIcons(){document.querySelectorAll(this.tagName).forEach(e=>{this.convertIcon(e)})}convertIcon(e){const t=this.icons[e.attributes[0].localName];if('undefined'!=typeof t){const a=this.svgTag.cloneNode(!0),o=t.viewbox.split(' ');a.setAttributeNS(null,'viewBox',t.viewbox),a.style.width=o[2]/o[3]+'em',a.style.height='1em',a.innerHTML=t.content,e.parentNode.replaceChild(a,e)}}addStyles(){const e=document.createElement('style');e.innerHTML=`.${this.className} { display: inline-block; font-size: inherit; overflow: visible; vertical-align: -0.125em; preserveAspectRatio: none; }`,document.head.appendChild(e)}}({icons:{settings:{viewbox:'0 0 512 512',content:'<path fill="currentColor" d="M444.788 291.1l42.616 24.599c4.867 2.809 7.126 8.618 5.459 13.985-11.07 35.642-29.97 67.842-54.689 94.586a12.016 12.016 0 0 1-14.832 2.254l-42.584-24.595a191.577 191.577 0 0 1-60.759 35.13v49.182a12.01 12.01 0 0 1-9.377 11.718c-34.956 7.85-72.499 8.256-109.219.007-5.49-1.233-9.403-6.096-9.403-11.723v-49.184a191.555 191.555 0 0 1-60.759-35.13l-42.584 24.595a12.016 12.016 0 0 1-14.832-2.254c-24.718-26.744-43.619-58.944-54.689-94.586-1.667-5.366.592-11.175 5.459-13.985L67.212 291.1a193.48 193.48 0 0 1 0-70.199l-42.616-24.599c-4.867-2.809-7.126-8.618-5.459-13.985 11.07-35.642 29.97-67.842 54.689-94.586a12.016 12.016 0 0 1 14.832-2.254l42.584 24.595a191.577 191.577 0 0 1 60.759-35.13V25.759a12.01 12.01 0 0 1 9.377-11.718c34.956-7.85 72.499-8.256 109.219-.007 5.49 1.233 9.403 6.096 9.403 11.723v49.184a191.555 191.555 0 0 1 60.759 35.13l42.584-24.595a12.016 12.016 0 0 1 14.832 2.254c24.718 26.744 43.619 58.944 54.689 94.586 1.667 5.366-.592 11.175-5.459 13.985L444.788 220.9a193.485 193.485 0 0 1 0 70.2zM336 256c0-44.112-35.888-80-80-80s-80 35.888-80 80 35.888 80 80 80 80-35.888 80-80z" class=""></path>'},back:{viewbox:'0 0 512 512',content:'<path transform="translate(512, 0) scale(-1,1)" fill="currentColor" d="M503.691 189.836L327.687 37.851C312.281 24.546 288 35.347 288 56.015v80.053C127.371 137.907 0 170.1 0 322.326c0 61.441 39.581 122.309 83.333 154.132 13.653 9.931 33.111-2.533 28.077-18.631C66.066 312.814 132.917 274.316 288 272.085V360c0 20.7 24.3 31.453 39.687 18.164l176.004-152c11.071-9.562 11.086-26.753 0-36.328z" class=""></path>'},trophy:{viewbox:'0 0 576 512',content:'<path fill="currentColor" d="M552 64H448V24c0-13.3-10.7-24-24-24H152c-13.3 0-24 10.7-24 24v40H24C10.7 64 0 74.7 0 88v56c0 66.5 77.9 131.7 171.9 142.4C203.3 338.5 240 360 240 360v72h-48c-35.3 0-64 20.7-64 56v12c0 6.6 5.4 12 12 12h296c6.6 0 12-5.4 12-12v-12c0-35.3-28.7-56-64-56h-48v-72s36.7-21.5 68.1-73.6C498.4 275.6 576 210.3 576 144V88c0-13.3-10.7-24-24-24zM64 144v-16h64.2c1 32.6 5.8 61.2 12.8 86.2-47.5-16.4-77-49.9-77-70.2zm448 0c0 20.2-29.4 53.8-77 70.2 7-25 11.8-53.6 12.8-86.2H512v16zm-127.3 4.7l-39.6 38.6 9.4 54.6c1.7 9.8-8.7 17.2-17.4 12.6l-49-25.8-49 25.8c-8.8 4.6-19.1-2.9-17.4-12.6l9.4-54.6-39.6-38.6c-7.1-6.9-3.2-19 6.7-20.5l54.8-8 24.5-49.6c4.4-8.9 17.1-8.9 21.5 0l24.5 49.6 54.8 8c9.6 1.5 13.5 13.6 6.4 20.5z" class=""></path>'},cancel:{viewbox:'0 0 352 512',content:'<path fill="currentColor" d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z" />'}},convert:!0});window.game=new class{constructor(){this.dom={ui:document.querySelector('.ui'),game:document.querySelector('.ui__game'),back:document.querySelector('.ui__background'),texts:document.querySelector('.ui__texts'),prefs:document.querySelector('.ui__prefs'),stats:document.querySelector('.ui__stats'),texts:{title:document.querySelector('.text--title'),note:document.querySelector('.text--note'),timer:document.querySelector('.text--timer'),stats:document.querySelector('.text--timer'),complete:document.querySelector('.text--complete'),best:document.querySelector('.text--best-time')},buttons:{prefs:document.querySelector('.btn--prefs'),back:document.querySelector('.btn--back'),stats:document.querySelector('.btn--stats'),cancel:document.querySelector('.btn--cancel')},rangeHandles:document.querySelectorAll('.range__handle div')},this.world=new g(this),this.cube=new h(this),this.controls=new x(this),this.scrambler=new w(this),this.transition=new z(this),this.timer=new C(this),this.preferences=new T(this),this.scores=new D(this),this.storage=new M(this),this.confetti=new A(this),this.themes=new _(this),this.initActions(),this.state=0,this.newGame=!1,this.saved=!1,this.storage.init(),this.preferences.init(),this.cube.init(),this.transition.init(),this.storage.loadGame(),this.scores.calcStats(),setTimeout(()=>{this.transition.float(),this.transition.cube(!0),setTimeout(()=>this.transition.title(!0),700),setTimeout(()=>this.transition.buttons(['prefs','stats'],[]),1e3)},500)}initActions(){let e=!1;this.dom.game.onclick=()=>{if(!(0<this.transition.activeTransitions)&&1!==this.state)if(0===this.state){if(!e)return e=!0,setTimeout(()=>e=!1,300),!1;this.saved||(this.scrambler.scramble(),this.controls.scrambleCube(),this.newGame=!0);const t=this.saved?0:this.scrambler.converted.length*(this.controls.flipSpeeds[0]+10);this.state=1,this.saved=!0,this.transition.buttons([],['stats','prefs']),this.transition.zoom(1,t),this.transition.title(!1),setTimeout(()=>{this.transition.timer(!0),this.transition.buttons(['back','cancel'],[])},this.transition.durations.zoom-1e3),setTimeout(()=>{this.controls.enable(),this.newGame||this.timer.start(!0)},this.transition.durations.zoom)}else{if(2===this.state)return this.state=3,this.saved=!1,this.transition.timer(!1),this.transition.complete(!1,this.bestTime),this.transition.cube(!1),this.timer.reset(),setTimeout(()=>{this.cube.reset(),this.confetti.stop(),this.transition.stats(!0),this.transition.elevate(0)},1e3),!1;3===this.state?(this.state=0,this.transition.buttons(['stats','prefs'],[]),this.transition.stats(!1),setTimeout(()=>this.transition.cube(!0),500),setTimeout(()=>this.transition.title(!0),1200)):4===this.state&&(this.cube.resize(),this.state=0,this.transition.buttons(['stats','prefs'],[]),this.transition.preferences(!1),setTimeout(()=>this.transition.cube(!0),500),setTimeout(()=>this.transition.title(!0),1200))}},this.controls.onMove=()=>{this.newGame&&(this.timer.start(!0),this.newGame=!1)},this.dom.buttons.back.onclick=()=>{0<this.transition.activeTransitions||1!==this.state||(this.state=0,this.transition.buttons(['stats','prefs'],['back','cancel']),this.transition.zoom(0,0),this.controls.disable(),!this.newGame&&this.timer.stop(),this.transition.timer(!1),setTimeout(()=>this.transition.title(!0),this.transition.durations.zoom-1e3),this.playing=!1,this.controls.disable())},this.dom.buttons.prefs.onclick=()=>{0<this.transition.activeTransitions||(this.state=4,this.transition.buttons([],['stats','prefs']),this.transition.title(!1),this.transition.cube(!1),setTimeout(()=>this.transition.preferences(!0),1e3))},this.dom.buttons.stats.onclick=()=>{0<this.transition.activeTransitions||(this.state=3,this.transition.buttons([],['stats','prefs']),this.transition.title(!1),this.transition.cube(!1),setTimeout(()=>this.transition.stats(!0),1e3))},this.controls.onSolved=()=>{this.transition.buttons([],['back']),this.state=2,this.saved=!1,this.controls.disable(),this.timer.stop(),this.storage.clearGame(),this.bestTime=this.scores.addScore(this.timer.deltaTime),this.transition.zoom(0,0),this.transition.elevate(!0),setTimeout(()=>{this.transition.complete(!0,this.bestTime),this.confetti.start()},1e3)}}}})();
